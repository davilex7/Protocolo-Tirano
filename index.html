<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo Tirano II</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .modal {
            display: none;
        }
        .modal.is-open {
            display: flex;
        }
        .glassmorphism {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #4b5563;
            color: white;
            transition: background-color: 0.3s;
        }
        .btn-secondary:hover {
            background-color: #374151;
        }
         .btn-danger {
            background-color: #ef4444;
            color: white;
            transition: background-color: 0.3s;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- HEADER -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-white mb-2">Protocolo Tirano II</h1>
            <p class="text-lg text-gray-400">Sistema de gestión de competición. Sin emociones, solo datos.</p>
        </header>

        <!-- MAIN CONTENT -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- RANKING DE JUGADORES -->
            <section class="lg:col-span-1 p-6 rounded-lg glassmorphism">
                <h2 class="text-2xl font-bold text-white mb-4">Ranking de Versatilidad</h2>
                <div id="player-ranking" class="space-y-3">
                    <!-- Player rankings will be injected here by JS -->
                </div>
            </section>

            <!-- LISTA DE JUEGOS -->
            <section class="lg:col-span-2 p-6 rounded-lg glassmorphism">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">Lista de Juegos Jerarquizada</h2>
                    <button id="add-game-btn" class="btn-primary font-semibold py-2 px-4 rounded-lg">Nominar Juego</button>
                </div>
                <div id="game-list" class="space-y-4">
                    <!-- Game list will be injected here by JS -->
                </div>
            </section>

        </main>

        <!-- DATA MANAGEMENT -->
        <footer class="mt-8 p-6 rounded-lg glassmorphism text-center">
            <h3 class="text-xl font-bold text-white mb-3">Sincronización de Datos</h3>
            <p class="text-gray-400 mb-4 max-w-2xl mx-auto">Este sistema es local. Para sincronizar entre los 4 miembros, un "administrador" debe exportar los datos y compartir el fichero .json. El resto debe importarlo para actualizar su estado.</p>
            <div class="flex justify-center gap-4">
                <button id="export-data-btn" class="btn-secondary font-semibold py-2 px-4 rounded-lg">Exportar Datos</button>
                <button onclick="document.getElementById('import-file').click()" class="btn-secondary font-semibold py-2 px-4 rounded-lg">Importar Datos</button>
                <input type="file" id="import-file" class="hidden" accept=".json">
                 <button id="reset-data-btn" class="btn-danger font-semibold py-2 px-4 rounded-lg">Resetear Todo</button>
            </div>
        </footer>
    </div>

    <!-- MODALS -->
    <!-- Add Game Modal -->
    <div id="add-game-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center">
        <div class="glassmorphism rounded-lg p-8 w-full max-w-md">
            <h3 class="text-2xl font-bold text-white mb-6">Nominar un Nuevo Juego</h3>
            <form id="add-game-form">
                <input id="new-game-name" type="text" placeholder="Nombre del Juego" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 mb-4 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-add-game" class="btn-secondary font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="btn-primary font-semibold py-2 px-4 rounded-lg">Confirmar Nominación</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Vote Modal -->
    <div id="vote-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center">
        <div class="glassmorphism rounded-lg p-8 w-full max-w-2xl">
            <h3 class="text-2xl font-bold text-white mb-2">Votación Obligatoria: <span id="vote-game-name" class="text-blue-400"></span></h3>
            <p class="text-gray-400 mb-6">Cada jugador debe asignar una puntuación. Un 0 actúa como un rechazo.</p>
            <form id="vote-form" class="space-y-4">
                <!-- Voting inputs will be injected here by JS -->
            </form>
            <div class="flex justify-end gap-4 mt-6">
                 <button type="button" id="cancel-vote" class="btn-secondary font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                 <button type="button" id="submit-vote" class="btn-primary font-semibold py-2 px-4 rounded-lg">Registrar Votos</button>
            </div>
        </div>
    </div>

    <!-- Veto Modal -->
    <div id="veto-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center">
        <div class="glassmorphism rounded-lg p-8 w-full max-w-md text-center">
            <h3 class="text-2xl font-bold text-red-500 mb-4">Confirmar Veto</h3>
            <p class="text-gray-300 mb-6">Un Veto elimina permanentemente la nominación de un juego en esta temporada. Esta acción es irreversible y gasta tu único Veto. ¿Quién ejerce el Veto?</p>
            <div id="veto-player-selector" class="mb-6 space-y-2">
                 <!-- Veto player buttons will be injected here by JS -->
            </div>
            <button id="cancel-veto" class="btn-secondary font-semibold py-2 px-4 rounded-lg">Cancelar</button>
        </div>
    </div>


    <script>
        const DB_KEY = 'tirano2_db';

        // --- INITIAL STATE ---
        function getInitialState() {
            return {
                players: [
                    { id: 'david', name: 'David', score: 0, vetoes: 1 },
                    { id: 'pablo', name: 'Pablo', score: 0, vetoes: 1 },
                    { id: 'sergio', name: 'Sergio', score: 0, vetoes: 1 },
                    { id: 'miguel', name: 'Miguel', score: 0, vetoes: 1 },
                ],
                games: [
                    // Pre-populating with the valid list for convenience
                    "Stick Fight", "Ark: SA", "Fall guys", "Helldivers 2", "Phasmophobia", "Sea of Thieves", 
                    "Minecraft", "Dbd", "Fortnite", "CoD", "Valorant", "Overwatch", "Monster Hunter", 
                    "Killing Floor", "DayZ", "Mount & Blade", "R6", "DeepRook", "Rocket League", 
                    "PvZ", "GTA", "PUBG", "The Escapist 2", "Stardew Valley"
                ].map((name, index) => ({
                    id: index,
                    name: name,
                    status: 'pending_vote', // pending_vote, active, vetoed
                    votes: {}, // { david: null, pablo: null, sergio: null, miguel: null }
                    totalScore: 0
                }))
            };
        }

        let state = {};

        // --- CORE LOGIC ---
        function calculateScores() {
            // Reset player scores
            state.players.forEach(p => p.score = 0);
            
            state.games.forEach(game => {
                let gameTotal = 0;
                let hasZeroVote = false;
                for (const playerId in game.votes) {
                    const vote = game.votes[playerId];
                    if (vote !== null) {
                        const player = state.players.find(p => p.id === playerId);
                        if(player) player.score += vote;
                        gameTotal += vote;
                        if(vote === 0) hasZeroVote = true;
                    }
                }
                game.totalScore = gameTotal;
                // If a game has a 0 vote but is 'active', it means it cannot be played but points count
                if(game.status === 'active' && hasZeroVote) {
                   // This logic is handled visually, not by changing status
                }
            });
        }

        // --- RENDERING ---
        function render() {
            calculateScores();

            // Render Player Ranking
            const playerRankingEl = document.getElementById('player-ranking');
            playerRankingEl.innerHTML = '';
            const sortedPlayers = [...state.players].sort((a, b) => b.score - a.score);
            sortedPlayers.forEach((player, index) => {
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '';
                playerRankingEl.innerHTML += `
                    <div class="p-4 rounded-lg bg-gray-800 flex justify-between items-center">
                        <div class="flex items-center">
                             <span class="text-2xl w-8">${medal || `_`}</span>
                             <span class="font-bold text-lg text-white">${player.name}</span>
                        </div>
                        <div class="text-right">
                           <div class="text-2xl font-bold text-blue-400">${player.score}</div>
                           <div class="text-xs text-gray-400">Vetos: ${player.vetoes}</div>
                        </div>
                    </div>
                `;
            });
            
            // Render Game List
            const gameListEl = document.getElementById('game-list');
            gameListEl.innerHTML = '';
            const sortedGames = [...state.games].sort((a, b) => {
                if(a.status === 'pending_vote' && b.status !== 'pending_vote') return -1;
                if(a.status !== 'pending_vote' && b.status === 'pending_vote') return 1;
                if(a.status === 'vetoed' && b.status !== 'vetoed') return 1;
                if(a.status !== 'vetoed' && b.status === 'vetoed') return -1;
                return b.totalScore - a.totalScore;
            });

            if (sortedGames.length === 0) {
                 gameListEl.innerHTML = `<div class="text-center text-gray-400 py-8">No hay juegos nominados.</div>`
            }

            sortedGames.forEach(game => {
                let gameHTML = '';
                const votesSummary = Object.values(game.votes).filter(v => v !== null).length;
                const totalPlayers = state.players.length;
                let hasZeroVote = Object.values(game.votes).includes(0);

                const getVoteBadge = (vote) => {
                    if (vote === null) return '';
                    const colors = { 0: 'bg-red-500', 1: 'bg-yellow-500', 2: 'bg-blue-500', 3: 'bg-green-500' };
                    return `<span class="text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full ${colors[vote]}">${vote}</span>`;
                };

                const playerVotesHTML = state.players.map(p => `
                    <div class="flex flex-col items-center">
                        <span class="text-xs text-gray-400 mb-1">${p.name}</span>
                        ${getVoteBadge(game.votes[p.id] ?? null)}
                    </div>
                `).join('');

                if (game.status === 'pending_vote') {
                    gameHTML = `
                        <div class="p-4 rounded-lg border-2 border-dashed border-blue-500 bg-blue-500 bg-opacity-10">
                            <div class="flex justify-between items-center">
                                <span class="text-xl font-bold text-white">${game.name}</span>
                                <div class="flex gap-2">
                                    <button class="vote-btn btn-primary text-sm font-semibold py-1 px-3 rounded-lg" data-gameid="${game.id}">Votar</button>
                                    <button class="veto-btn btn-danger text-sm font-semibold py-1 px-3 rounded-lg" data-gameid="${game.id}">Vetar</button>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (game.status === 'vetoed') {
                    const vetoer = state.players.find(p => p.id === game.vetoedBy);
                    gameHTML = `
                        <div class="p-4 rounded-lg bg-red-900 bg-opacity-50 opacity-50">
                            <div class="flex justify-between items-center">
                                <span class="text-xl font-bold text-gray-400 line-through">${game.name}</span>
                                <span class="text-sm font-semibold text-red-400">VETADO ${vetoer ? `POR ${vetoer.name.toUpperCase()}` : ''}</span>
                            </div>
                        </div>
                    `;
                } else { // active
                     gameHTML = `
                        <div class="p-4 rounded-lg bg-gray-800 ${hasZeroVote ? 'border-2 border-red-600' : ''}">
                             <div class="flex justify-between items-center mb-3">
                                <h4 class="text-xl font-bold text-white">${game.name}</h4>
                                <div class="flex items-center gap-2">
                                     <span class="text-3xl font-bold text-blue-400">${game.totalScore}</span>
                                     <span class="text-sm text-gray-400">puntos</span>
                                </div>
                             </div>
                             <div class="flex justify-around items-center p-2 bg-gray-900 rounded-lg">
                                ${playerVotesHTML}
                             </div>
                             ${hasZeroVote ? '<p class="text-red-500 text-xs text-center mt-2">Este juego no se puede jugar (voto de Rechazo Absoluto presente).</p>' : ''}
                        </div>
                    `;
                }
                gameListEl.innerHTML += gameHTML;
            });

            addEventListeners();
        }
        
        // --- EVENT LISTENERS ---
        function addEventListeners() {
            // Vote buttons
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.onclick = (e) => openVoteModal(e.currentTarget.dataset.gameid);
            });
            // Veto buttons
            document.querySelectorAll('.veto-btn').forEach(btn => {
                btn.onclick = (e) => openVetoModal(e.currentTarget.dataset.gameid);
            });
        }
        
        // --- MODAL HANDLING ---
        const addGameModal = document.getElementById('add-game-modal');
        const voteModal = document.getElementById('vote-modal');
        const vetoModal = document.getElementById('veto-modal');
        
        // Add Game
        document.getElementById('add-game-btn').onclick = () => addGameModal.classList.add('is-open');
        document.getElementById('cancel-add-game').onclick = () => addGameModal.classList.remove('is-open');
        document.getElementById('add-game-form').onsubmit = (e) => {
            e.preventDefault();
            const gameNameInput = document.getElementById('new-game-name');
            const name = gameNameInput.value.trim();
            if (name && !state.games.find(g => g.name.toLowerCase() === name.toLowerCase())) {
                const newGame = {
                    id: state.games.length > 0 ? Math.max(...state.games.map(g => g.id)) + 1 : 0,
                    name: name,
                    status: 'pending_vote',
                    votes: {},
                    totalScore: 0
                };
                state.games.push(newGame);
                saveState();
                render();
                gameNameInput.value = '';
                addGameModal.classList.remove('is-open');
            } else {
                alert('El nombre del juego no puede estar vacío o ya existe.');
            }
        };

        // Vote
        function openVoteModal(gameId) {
            const game = state.games.find(g => g.id == gameId);
            if (!game) return;

            document.getElementById('vote-game-name').textContent = game.name;
            const voteForm = document.getElementById('vote-form');
            voteForm.innerHTML = '';
            voteForm.dataset.gameid = gameId;

            state.players.forEach(player => {
                voteForm.innerHTML += `
                    <div class="grid grid-cols-3 items-center gap-4">
                        <label class="font-semibold text-white">${player.name}:</label>
                        <select data-playerid="${player.id}" class="col-span-2 w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="3">3 (Prioridad Alta)</option>
                            <option value="2" selected>2 (Aceptable)</option>
                            <option value="1">1 (Tolerable)</option>
                            <option value="0">0 (Rechazo Absoluto)</option>
                        </select>
                    </div>
                `;
            });
            voteModal.classList.add('is-open');
        }
        document.getElementById('cancel-vote').onclick = () => voteModal.classList.remove('is-open');
        document.getElementById('submit-vote').onclick = () => {
            const gameId = document.getElementById('vote-form').dataset.gameid;
            const game = state.games.find(g => g.id == gameId);
            if(game) {
                const selects = document.querySelectorAll('#vote-form select');
                selects.forEach(select => {
                    const playerId = select.dataset.playerid;
                    game.votes[playerId] = parseInt(select.value);
                });
                game.status = 'active';
                saveState();
                render();
                voteModal.classList.remove('is-open');
            }
        };

        // Veto
        function openVetoModal(gameId) {
            const game = state.games.find(g => g.id == gameId);
            if (!game) return;

            const selector = document.getElementById('veto-player-selector');
            selector.innerHTML = '';
            selector.dataset.gameid = gameId;

            state.players.forEach(player => {
                if(player.vetoes > 0) {
                     selector.innerHTML += `<button class="veto-player-btn btn-secondary font-semibold py-2 px-4 rounded-lg w-full mb-2" data-playerid="${player.id}">${player.name} (Vetos: ${player.vetoes})</button>`;
                } else {
                     selector.innerHTML += `<button class="btn-secondary font-semibold py-2 px-4 rounded-lg w-full mb-2 opacity-50 cursor-not-allowed" disabled>${player.name} (Sin Vetos)</button>`;
                }
            });
            vetoModal.classList.add('is-open');
        }
        document.addEventListener('click', function(e){
            if(e.target && e.target.classList.contains('veto-player-btn')){
                const playerId = e.target.dataset.playerid;
                const gameId = document.getElementById('veto-player-selector').dataset.gameid;
                const player = state.players.find(p => p.id === playerId);
                const game = state.games.find(g => g.id == gameId);

                if (player && player.vetoes > 0 && game) {
                    player.vetoes -= 1;
                    game.status = 'vetoed';
                    game.vetoedBy = playerId;
                    saveState();
                    render();
                    vetoModal.classList.remove('is-open');
                }
            }
        });
        document.getElementById('cancel-veto').onclick = () => vetoModal.classList.remove('is-open');


        // --- DATA PERSISTENCE ---
        function saveState() {
            localStorage.setItem(DB_KEY, JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem(DB_KEY);
            if (savedState) {
                state = JSON.parse(savedState);
            } else {
                state = getInitialState();
            }
        }
        
        // Data Management Buttons
        document.getElementById('export-data-btn').onclick = () => {
            const dataStr = JSON.stringify(state, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'tirano_db.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        };

        const importFileEl = document.getElementById('import-file');
        importFileEl.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedState = JSON.parse(event.target.result);
                    // Basic validation
                    if(importedState.players && importedState.games) {
                        state = importedState;
                        saveState();
                        render();
                        alert('Datos importados con éxito.');
                    } else {
                        throw new Error('Formato de fichero inválido.');
                    }
                } catch (err) {
                    alert('Error al importar el fichero: ' + err.message);
                } finally {
                    importFileEl.value = ''; // Reset input
                }
            };
            reader.readAsText(file);
        };
        
        document.getElementById('reset-data-btn').onclick = () => {
            if (confirm('¿ESTÁS SEGURO? Esta acción borrará TODOS los datos (puntuaciones, votos, vetos) y restaurará la lista de juegos inicial. Es irreversible.')) {
                state = getInitialState();
                saveState();
                render();
            }
        };

        // --- INITIALIZE APP ---
        window.onload = () => {
            loadState();
            render();
        };
    </script>
</body>
</html>
